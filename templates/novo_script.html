{% extends 'layout.html' %}

{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-plus-circle me-2"></i> Cadastrar Novo Script
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario']['nome'] }}</strong>
  </div>
</div>

<div class="container">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        <h5 class="text-primary">Informações do Script</h5>
        <div class="mb-3">
          <label class="form-label">Nome do Script *</label>
          <input type="text" class="form-control" id="nome" name="nome" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Pacote</label>
          <select name="codpacote" id="codpacote" class="form-select">
            <option value="">Nenhum</option>
            {% for pacote in pacotes %}
              <option value="{{ pacote[0] }}">{{ pacote[1] }}{% if pacote[2] %} - {{ pacote[2] }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Sistema</label>
          <select name="sistema" id="sistema" class="form-select" onchange="toggleCamposSistema()">
            <option value="">Nenhum</option>
            <option value="Laudos UX">Laudos UX</option>
            <option value="Laudos Flex">Laudos Flex</option>
          </select>
        </div>
        <div class="mb-3" id="campo-arquivo-json" style="display: none;">
          <label class="form-label">Arquivo JSON (Laudos UX) *</label>
          <input type="file" class="form-control" id="arquivo_json" name="arquivo_json" accept=".json">
        </div>
        <div class="mb-3" id="campo-arquivo-mrd" style="display: none;">
          <label class="form-label">Arquivo MRD</label>
          <input type="file" class="form-control" id="arquivo_mrd" name="arquivo_mrd" accept=".json,.mrd">
        </div>
        <div class="mb-3">
          <label class="form-label">Linguagem</label>
          <input type="text" class="form-control" id="linguagem" name="linguagem" placeholder="Ex.: C#, HTML" oninput="toggleCampoCaminhoProjeto()">
        </div>
        <div class="mb-3" id="campo-caminho-projeto" style="display: none;">
          <label class="form-label">Caminho do Projeto (C#)</label>
          <input type="text" class="form-control" id="caminho_projeto" name="caminho_projeto" placeholder="Ex.: /caminho/do/projeto">
        </div>
        <div class="mb-3" id="campo-caminho-azure" style="display: none;">
          <label class="form-label">Caminho do Projeto no Azure DevOps (C#)</label>
          <input type="text" class="form-control" id="caminho_azure" name="caminho_azure" placeholder="Ex.: https://dev.azure.com/org/project/_git/repo">
        </div>
        <div class="mb-3" id="campo-arquivo-dll" style="display: none;">
          <label class="form-label">Arquivo DLL (C#)</label>
          <input type="file" class="form-control" id="arquivo_dll" name="arquivo_dll" accept=".dll">
        </div>
        <div class="mb-3">
          <label class="form-label">Descrição</label>
          <textarea class="form-control" id="descricao" name="descricao" rows="5" maxlength="500" placeholder="Descreva a funcionalidade ou propósito do script"></textarea>
          <small class="form-text text-muted">Máximo de 500 caracteres.</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Imagens da Interface (PNG, JPG)</label>
          <input type="file" class="form-control" id="imagens" name="imagens[]" accept=".png,.jpg,.jpeg" multiple>
          <small class="form-text text-muted">Selecione uma ou mais imagens (máximo 5MB cada).</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Impressões (PDF)</label>
          <input type="file" class="form-control" id="pdfs" name="pdfs[]" accept=".pdf" multiple>
          <small class="form-text text-muted">Selecione um ou mais PDFs (máximo 5MB cada).</small>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="aprovado" name="aprovado" onchange="toggleAprovadoPor()">
          <label class="form-check-label" for="aprovado">Aprovado</label>
        </div>
        <div class="mb-3" id="campo-aprovado-por" style="display: none;">
          <label class="form-label">Aprovado Por *</label>
          <input type="text" class="form-control" id="aprovado_por" name="aprovado_por" placeholder="Ex.: Dr. João Silva ou Clínica São Paulo">
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="ativo" name="ativo" checked>
          <label class="form-check-label" for="ativo">Ativo</label>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-success" onclick="confirmarSalvarScript()">
            <i class="bi bi-save"></i> Salvar
          </button>
          <a href="{{ url_for('bibliotecas.biblioteca') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar para Biblioteca
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleCamposCondicionais() {
    const sistemaSelect = document.getElementById('sistema');
    const linguagemInput = document.getElementById('linguagem');
    
    const sistema = sistemaSelect ? sistemaSelect.value : '';
    const linguagem = linguagemInput ? linguagemInput.value.trim().toUpperCase() : '';

    const campoArquivoJson = document.getElementById('campo-arquivo-json');
    const arquivoJsonInput = document.getElementById('arquivo_json');
    
    const campoArquivoMrd = document.getElementById('campo-arquivo-mrd');
    const arquivoMrdInput = document.getElementById('arquivo_mrd');

    const campoCaminhoProjeto = document.getElementById('campo-caminho-projeto'); // C# Geral
    const campoArquivoDll = document.getElementById('campo-arquivo-dll');     // C# Geral
    const campoCaminhoAzure = document.getElementById('campo-caminho-azure'); // C# + Laudos Flex

    // Visibilidade do Arquivo JSON (somente Laudos UX)
    if (campoArquivoJson) {
        campoArquivoJson.style.display = (sistema === 'Laudos UX') ? 'block' : 'none';
        if (arquivoJsonInput) {
            if (sistema === 'Laudos UX' && !arquivoJsonInput.value && !document.querySelector('input[name="codscriptlaudo"]')) { // Apenas obrigatório em novo_script
                arquivoJsonInput.setAttribute('required', 'required');
            } else {
                arquivoJsonInput.removeAttribute('required');
            }
        }
    }

    // Visibilidade e tipo do Arquivo MRD
    if (campoArquivoMrd) {
        campoArquivoMrd.style.display = (sistema === 'Laudos UX' || sistema === 'Laudos Flex') ? 'block' : 'none';
        if (arquivoMrdInput) {
            if (sistema === 'Laudos UX') {
                arquivoMrdInput.setAttribute('accept', '.json');
            } else if (sistema === 'Laudos Flex') {
                arquivoMrdInput.setAttribute('accept', '.mrd');
            } else {
                arquivoMrdInput.removeAttribute('accept');
            }
        }
    }

    // Visibilidade do Caminho do Projeto e DLL (somente C#)
    const isCSharp = (linguagem === 'C#');
    if (campoCaminhoProjeto) {
        campoCaminhoProjeto.style.display = isCSharp ? 'block' : 'none';
    }
    if (campoArquivoDll) {
        campoArquivoDll.style.display = isCSharp ? 'block' : 'none';
    }

    // Visibilidade do Caminho Azure DevOps (C# E Laudos Flex)
    if (campoCaminhoAzure) {
        campoCaminhoAzure.style.display = (isCSharp && sistema === 'Laudos Flex') ? 'block' : 'none';
    }
}

function toggleAprovadoPor() {
    const aprovadoCheckbox = document.getElementById('aprovado');
    const campoAprovadoPor = document.getElementById('campo-aprovado-por');
    const aprovadoPorInput = document.getElementById('aprovado_por');

    if (aprovadoCheckbox && campoAprovadoPor && aprovadoPorInput) {
        if (aprovadoCheckbox.checked) {
            campoAprovadoPor.style.display = 'block';
            aprovadoPorInput.setAttribute('required', 'required');
        } else {
            campoAprovadoPor.style.display = 'none';
            aprovadoPorInput.removeAttribute('required');
            aprovadoPorInput.value = ''; // Limpa o campo se desmarcado
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    
    toggleCamposCondicionais(); // Chamada inicial para configurar a visibilidade
    toggleAprovadoPor();      // Chamada inicial para o campo 'Aprovado Por'

    const sistemaSelect = document.getElementById('sistema');
    const linguagemInput = document.getElementById('linguagem');
    const aprovadoCheckbox = document.getElementById('aprovado');

    if (sistemaSelect) {
        sistemaSelect.addEventListener('change', toggleCamposCondicionais);
    }
    if (linguagemInput) {
        linguagemInput.addEventListener('input', toggleCamposCondicionais);
    }
    if (aprovadoCheckbox) {
        aprovadoCheckbox.addEventListener('change', toggleAprovadoPor);
    }

  
});



function toggleAprovadoPor() {
  const aprovado = document.getElementById('aprovado').checked;
  const campoAprovadoPor = document.getElementById('campo-aprovado-por');
  if (aprovado) {
    campoAprovadoPor.style.display = 'block';
    document.getElementById('aprovado_por').setAttribute('required', 'required');
  } else {
    campoAprovadoPor.style.display = 'none';
    document.getElementById('aprovado_por').removeAttribute('required');
  }
}

function confirmarSalvarScript() {
  const nome = document.getElementById('nome').value.trim();
  const sistema = document.getElementById('sistema').value;
  const arquivoJson = document.getElementById('arquivo_json').files[0];
  const arquivoMrd = document.getElementById('arquivo_mrd').files[0];
  const arquivoDll = document.getElementById('arquivo_dll')?.files[0];
  const aprovado = document.getElementById('aprovado').checked;
  const aprovadoPor = document.getElementById('aprovado_por').value.trim();
  const imagens = document.getElementById('imagens').files;
  const pdfs = document.getElementById('pdfs').files;

  if (!nome) {
    Swal.fire({
      icon: 'warning',
      title: 'Nome inválido',
      text: 'O nome do script é obrigatório.'
    });
    return;
  }

  if (sistema === 'Laudos UX') {
    if (!arquivoJson) {
      Swal.fire({
        icon: 'warning',
        title: 'Arquivo JSON obrigatório',
        text: 'Você deve selecionar um arquivo JSON para o sistema Laudos UX.'
      });
      return;
    }
    if (!arquivoJson.name.endsWith('.json')) {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'O arquivo JSON deve ter a extensão .json.'
      });
      return;
    }
    if (arquivoMrd && !arquivoMrd.name.endsWith('.json')) {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'O arquivo MRD para Laudos UX deve ter a extensão .json.'
      });
      return;
    }
  } else if (sistema === 'Laudos Flex' && arquivoMrd && !arquivoMrd.name.endsWith('.mrd')) {
    Swal.fire({
      icon: 'warning',
      title: 'Formato inválido',
      text: 'O arquivo MRD para Laudos Flex deve ter a extensão .mrd.'
    });
    return;
  }

  if (arquivoDll && !arquivoDll.name.endsWith('.dll')) {
    Swal.fire({
      icon: 'warning',
      title: 'Formato inválido',
      text: 'O arquivo DLL deve ter a extensão .dll.'
    });
    return;
  }

  if (aprovado && !aprovadoPor) {
    Swal.fire({
      icon: 'warning',
      title: 'Aprovador inválido',
      text: 'O nome do aprovador é obrigatório quando o script é marcado como aprovado.'
    });
    return;
  }

  for (let img of imagens) {
    if (!['image/png', 'image/jpeg'].includes(img.type)) {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'As imagens devem ser PNG ou JPG.'
      });
      return;
    }
    if (img.size > 5 * 1024 * 1024) {
      Swal.fire({
        icon: 'warning',
        title: 'Arquivo muito grande',
        text: 'As imagens não podem exceder 5MB.'
      });
      return;
    }
  }

  for (let pdf of pdfs) {
    if (pdf.type !== 'application/pdf') {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'Os arquivos de impressão devem ser PDF.'
      });
      return;
    }
    if (pdf.size > 5 * 1024 * 1024) {
      Swal.fire({
        icon: 'warning',
        title: 'Arquivo muito grande',
        text: 'Os PDFs não podem exceder 5MB.'
      });
      return;
    }
  }

  Swal.fire({
    title: 'Salvar script?',
    text: 'Deseja realmente salvar esse script?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sim, salvar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      document.querySelector('form').submit();
    }
  });
}
</script>
{% endset %}