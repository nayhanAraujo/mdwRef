{% extends 'layout.html' %}

{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-pencil-square me-2"></i> Editar variável
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario'] }}</strong>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form method="POST">
      <h5 class="text-primary">Informações da Variável</h5>
      
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Nome clínico</label>
          <input type="text" name="nome" class="form-control" value="{{ variavel[0] }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Variável</label>
          <input type="text" name="variavel" class="form-control" value="{{ variavel[1] }}" required placeholder="Ex: VR_AE">
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Sigla</label>
          <input type="text" name="sigla" class="form-control" value="{{ variavel[2] }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Abreviação</label>
          <input type="text" name="abreviacao" class="form-control" value="{{ variavel[3] }}" required>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Descrição</label>
        <textarea name="descricao" class="form-control" rows="3">{{ variavel[4] }}</textarea>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Unidade de Medida</label>
          <select name="unidade" class="form-select" required>
            <option value="">-- Selecione uma unidade --</option>
            {% for cod, descricao in unidades %}
              <option value="{{ cod }}" {% if cod == variavel[5] %}selected{% endif %}>{{ descricao }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Casas Decimais</label>
          <input type="number" name="casas_decimais" class="form-control" min="0" value="{{ variavel[6] }}" required>
        </div>
      </div>

      {% if variavel[7] is not none %}
      <hr>
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="possuiFormula" name="possui_formula" checked>
        <label class="form-check-label" for="possuiFormula">Alterar Fórmula?</label>
      </div>

      <div id="areaFormula">
        <div class="mb-3">
          <label class="form-label">Variáveis disponíveis</label>
          <div class="input-group mb-2">
            <select class="form-select" id="variavelSelect">
              <option value="">-- Selecione uma variável --</option>
              {% for sigla, nome in variaveis_existentes %}
                <option value="<<{{ sigla }}>>">{{ nome }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-outline-primary" onclick="inserirVariavel()">
              Inserir na fórmula
            </button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Fórmula</label>
          <textarea name="formula" class="form-control">{{ variavel[7] }}</textarea>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Casas Decimais (Fórmula)</label>
          <input type="number" name="formula_casas_decimais" class="form-control" min="0" value="{{ variavel[8] }}">
        </div>
      </div>
      {% endif %}

      <hr>
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="possuiNormalidade" name="possui_normalidade" {% if variavel[9] is not none %}checked{% endif %}>
        <label class="form-check-label" for="possuiNormalidade">Alterar Normalidade ou referência?</label>
      </div>

      <div id="areaNormalidade" style="display: {% if variavel[9] is not none %}block{% else %}none{% endif %};">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Sexo</label>
            <select name="sexo" class="form-select">
              <option value="M" {% if variavel[9] == 'M' %}selected{% endif %}>Masculino</option>
              <option value="F" {% if variavel[9] == 'F' %}selected{% endif %}>Feminino</option>
              <option value="A" {% if variavel[9] == 'A' %}selected{% endif %}>Ambos</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Valor Mínimo</label>
            <input type="number" step="any" name="valormin" class="form-control" value="{{ variavel[10] }}">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Valor Máximo</label>
            <input type="number" step="any" name="valormax" class="form-control" value="{{ variavel[11] }}">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Idade Mínima</label>
            <input type="number" name="idade_min" class="form-control" value="{{ variavel[12] }}">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Idade Máxima</label>
            <input type="number" name="idade_max" class="form-control" value="{{ variavel[13] }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Referência</label>
            <select name="referencia" class="form-select">
              <option value="">-- Nenhuma --</option>
              {% for cod, autor, ano in referencias %}
                <option value="{{ cod }}" {% if cod == variavel[14] %}selected{% endif %}>{{ autor }} - {{ ano }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-circle me-1"></i> Salvar Alterações
        </button>
        <a href="{{ url_for('visualizar_variaveis') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i> Cancelar
        </a>
      </div>
      
    </form>
  </div>
</div>

<script>
  document.getElementById('possuiFormula').addEventListener('change', function() {
    document.getElementById('areaFormula').style.display = this.checked ? 'block' : 'none';
  });
  document.getElementById('possuiNormalidade').addEventListener('change', function() {
    document.getElementById('areaNormalidade').style.display = this.checked ? 'block' : 'none';
  });
</script>
{% endset %}
