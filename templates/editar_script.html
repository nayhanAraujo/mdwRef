{% extends 'layout.html' %}

{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-pencil-square me-2"></i> Editar Script
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario']['nome'] }}</strong>
  </div>
</div>

<div class="container">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        <h5 class="text-primary">Informações do Script</h5>
        <div class="mb-3">
          <label for="nome" class="form-label">Nome *</label>
          <input type="text" name="nome" id="nome" class="form-control" value="{{ script.nome }}" required>
        </div>
        <div class="mb-3">
          <label for="codpacote" class="form-label">Pacote</label>
          <select name="codpacote" id="codpacote" class="form-select">
            <option value="">Nenhum</option>
            {% for pacote in pacotes %}
              <option value="{{ pacote[0] }}" {% if script.codpacote == pacote[0] %}selected{% endif %}>{{ pacote[1] }}{% if pacote[2] %} - {{ pacote[2] }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="sistema" class="form-label">Sistema</label>
          <select name="sistema" id="sistema" class="form-select" onchange="toggleCamposSistema()">
            <option value="">Nenhum</option>
            <option value="Laudos UX" {% if script.sistema == 'Laudos UX' %}selected{% endif %}>Laudos UX</option>
            <option value="Laudos Flex" {% if script.sistema == 'Laudos Flex' %}selected{% endif %}>Laudos Flex</option>
          </select>
        </div>
        <div class="mb-3" id="campo-arquivo-json" style="display: {% if script.sistema == 'Laudos UX' %}block{% else %}none{% endif %};">
          <label for="arquivo_json" class="form-label">Arquivo JSON (Laudos UX)</label>
          <input type="file" class="form-control" id="arquivo_json" name="arquivo_json" accept=".json">
          {% if script.tem_arquivo_json %}
            <small class="form-text text-muted">Arquivo JSON existente. Selecione um novo arquivo para substituí-lo.</small>
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="linguagem" class="form-label">Linguagem</label>
          <input type="text" name="linguagem" id="linguagem" class="form-control" value="{{ script.linguagem }}" placeholder="Ex.: C#, HTML" oninput="toggleCampoCaminhoProjeto()">
        </div>
        <div class="mb-3" id="campo-caminho-projeto" style="display: {% if script.linguagem|upper == 'C#' %}block{% else %}none{% endif %};">
          <label for="caminho_projeto" class="form-label">Caminho do Projeto (C#)</label>
          <input type="text" name="caminho_projeto" id="caminho_projeto" class="form-control" value="{{ script.caminho_projeto }}" placeholder="Ex.: /caminho/do/projeto">
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descrição</label>
          <textarea name="descricao" id="descricao" class="form-control" rows="5" maxlength="255" placeholder="Descreva a funcionalidade ou propósito do script">{{ script.descricao }}</textarea>
          <small class="form-text text-muted">Máximo de 255 caracteres.</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Imagens da Interface (PNG, JPG)</label>
          <input type="file" class="form-control" id="imagens" name="imagens[]" accept=".png,.jpg,.jpeg" multiple>
          <small class="form-text text-muted">Selecione uma ou mais imagens (máximo 5MB cada).</small>
          {% if script.imagens %}
            <h6 class="mt-3">Imagens Existentes</h6>
            <ul class="list-group">
              {% for imagem in script.imagens %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ imagem.nome }}</span>
                  <button type="button" class="btn btn-danger btn-sm" onclick="confirmarExcluirArquivo({{ imagem.codarquivo }})">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label">Impressões (PDF)</label>
          <input type="file" class="form-control" id="pdfs" name="pdfs[]" accept=".pdf" multiple>
          <small class="form-text text-muted">Selecione um ou mais PDFs (máximo 5MB cada).</small>
          {% if script.pdfs %}
            <h6 class="mt-3">PDFs Existentes</h6>
            <ul class="list-group">
              {% for pdf in script.pdfs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ pdf.nome }}</span>
                  <button type="button" class="btn btn-danger btn-sm" onclick="confirmarExcluirArquivo({{ pdf.codarquivo }})">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="aprovado" name="aprovado" {% if script.aprovado %}checked{% endif %} onchange="toggleAprovadoPor()">
          <label class="form-check-label" for="aprovado">Aprovado</label>
        </div>
        <div class="mb-3" id="campo-aprovado-por" style="display: {% if script.aprovado %}block{% else %}none{% endif %};">
          <label for="aprovado_por" class="form-label">Aprovado Por *</label>
          <input type="text" class="form-control" id="aprovado_por" name="aprovado_por" value="{{ script.aprovado_por or '' }}" placeholder="Ex.: Dr. João Silva ou Clínica São Paulo">
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="ativo" name="ativo" {% if script.ativo %}checked{% endif %}>
          <label class="form-check-label" for="ativo">Ativo</label>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-success" onclick="confirmarSalvarScript()">
            <i class="bi bi-save"></i> Salvar
          </button>
          <a href="{{ url_for('scripts.visualizar_scripts') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleCamposSistema() {
  const sistema = document.getElementById('sistema').value;
  const campoArquivoJson = document.getElementById('campo-arquivo-json');
  if (sistema === 'Laudos UX') {
    campoArquivoJson.style.display = 'block';
  } else {
    campoArquivoJson.style.display = 'none';
  }
}

function toggleCampoCaminhoProjeto() {
  const linguagem = document.getElementById('linguagem').value.trim().toUpperCase();
  const campoCaminhoProjeto = document.getElementById('campo-caminho-projeto');
  if (linguagem === 'C#') {
    campoCaminhoProjeto.style.display = 'block';
  } else {
    campoCaminhoProjeto.style.display = 'none';
  }
}

function toggleAprovadoPor() {
  const aprovado = document.getElementById('aprovado').checked;
  const campoAprovadoPor = document.getElementById('campo-aprovado-por');
  if (aprovado) {
    campoAprovadoPor.style.display = 'block';
    document.getElementById('aprovado_por').setAttribute('required', 'required');
  } else {
    campoAprovadoPor.style.display = 'none';
    document.getElementById('aprovado_por').removeAttribute('required');
  }
}

function confirmarSalvarScript() {
  const nome = document.getElementById('nome').value.trim();
  const sistema = document.getElementById('sistema').value;
  const arquivoJson = document.getElementById('arquivo_json').files[0];
  const aprovado = document.getElementById('aprovado').checked;
  const aprovadoPor = document.getElementById('aprovado_por').value.trim();
  const imagens = document.getElementById('imagens').files;
  const pdfs = document.getElementById('pdfs').files;

  if (!nome) {
    Swal.fire({
      icon: 'warning',
      title: 'Nome inválido',
      text: 'O nome do script é obrigatório.'
    });
    return;
  }

  if (sistema === 'Laudos UX' && arquivoJson && !arquivoJson.name.endsWith('.json')) {
    Swal.fire({
      icon: 'warning',
      title: 'Formato inválido',
      text: 'O arquivo JSON deve ter a extensão .json.'
    });
    return;
  }

  if (aprovado && !aprovadoPor) {
    Swal.fire({
      icon: 'warning',
      title: 'Aprovador inválido',
      text: 'O nome do aprovador é obrigatório quando o script é marcado como aprovado.'
    });
    return;
  }

  for (let img of imagens) {
    if (!['image/png', 'image/jpeg'].includes(img.type)) {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'As imagens devem ser PNG ou JPG.'
      });
      return;
    }
    if (img.size > 5 * 1024 * 1024) {
      Swal.fire({
        icon: 'warning',
        title: 'Arquivo muito grande',
        text: 'As imagens não podem exceder 5MB.'
      });
      return;
    }
  }

  for (let pdf of pdfs) {
    if (pdf.type !== 'application/pdf') {
      Swal.fire({
        icon: 'warning',
        title: 'Formato inválido',
        text: 'Os arquivos de impressão devem ser PDF.'
      });
      return;
    }
    if (pdf.size > 5 * 1024 * 1024) {
      Swal.fire({
        icon: 'warning',
        title: 'Arquivo muito grande',
        text: 'Os PDFs não podem exceder 5MB.'
      });
      return;
    }
  }

  Swal.fire({
    title: 'Salvar alterações?',
    text: 'Deseja realmente salvar as alterações deste script?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sim, salvar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      document.querySelector('form').submit();
    }
  });
}

function confirmarExcluirArquivo(codarquivo) {
  Swal.fire({
    title: 'Excluir arquivo?',
    text: 'Esta ação não pode ser desfeita.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sim, excluir',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = `/scripts/excluir_arquivo/${codarquivo}`;
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  toggleCamposSistema();
  toggleCampoCaminhoProjeto();
  toggleAprovadoPor();
});
</script>
{% endset %}