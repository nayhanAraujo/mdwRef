{% extends 'layout.html' %}
{% block title %}Visualizar Variáveis{% endblock %}

{% set content %}
<div class="page-header mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2 class="page-title mb-0">
        <i class="bi bi-card-list me-2 icon-gradient"></i> 
        Visualizar Variáveis
      </h2>
    </div>
    <div class="text-muted small">
      <i class="bi bi-person-circle me-1"></i> Usuário: <strong>{{ session['usuario']['nome'] }}</strong>
    </div>
  </div>
  <hr class="mt-2 mb-0 page-header-divider">
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="row mb-4 align-items-center">
      <div class="col-md-5">
        <form method="GET" action="{{ url_for('variaveis.visualizar_variaveis') }}">
          <div class="input-group">
            <input type="text" name="variavel" class="form-control" placeholder="Pesquisar por nome ou variável..." value="{{ request.args.get('variavel', '') }}">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </form>
      </div>
      <div class="col-md-7 text-md-end mt-3 mt-md-0">
        <a href="{{ url_for('variaveis.nova_variavel') }}" class="btn btn-success me-1 mb-1 mb-md-0">
          <i class="bi bi-plus-circle me-1"></i> Nova Variável
        </a>
        <a href="{{ url_for('variaveis.importar_variaveis') }}" class="btn btn-info me-1 mb-1 mb-md-0">
          <i class="bi bi-upload me-1"></i> Importar Variáveis (.cs)
        </a>
        <a href="{{ url_for('variaveis.vincular_codigo_universal') }}" class="btn btn-secondary mb-1 mb-md-0">
          <i class="bi bi-link-45deg me-1"></i> Vincular Códigos DICOM
        </a>
      </div>
    </div>

    <div class="actions-legend mb-3 p-3 border rounded bg-light-subtle small">
      <h6 class="fw-bold mb-2"><i class="bi bi-key-fill me-1"></i>Legenda das Ações na Tabela:</h6>
      <div class="d-flex flex-wrap">
        <span class="me-3 mb-1"><i class="bi bi-paperclip text-dark"></i> Vincular Anexo</span>
        <span class="me-3 mb-1"><i class="bi bi-pencil-square text-primary"></i> Editar Variável</span>
        <span class="me-3 mb-1"><i class="bi bi-search-heart text-info"></i> Detalhes (Normalidade, Equações)</span>
        <span class="me-3 mb-1"><i class="bi bi-calculator text-success"></i> Ver Fórmula</span>
        <span class="me-3 mb-1"><i class="bi bi-book text-warning"></i> Consultar Estudos</span>
        <span class="me-3 mb-1"><i class="bi bi-qr-code-scan text-info"></i> Ver Códigos DICOM</span>
        <span class="me-3 mb-1"><i class="bi bi-trash text-danger"></i> Excluir Variável</span>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped table-hover">
        <thead class="table-light">
          <tr>
            <th class="text-center align-middle" style="width: 5%;">Código</th>
            <th class="text-start align-middle">Nome Clínico</th>
            <th class="text-start align-middle">Variável</th>
            <th class="text-center align-middle">Sigla</th>
            <th class="text-center align-middle">Abreviação</th>
            <th class="text-start align-middle">Alternativas</th>
            <th class="text-start align-middle">Scripts Vinculados</th>
            <th class="text-start align-middle">Anexos</th>
            <th class="text-center align-middle" style="width: 20%;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for detalhe in variaveis_detalhes %}
            <tr>
              <td class="text-center align-middle">{{ detalhe.variavel[0] }}</td>
              <td class="align-middle">{{ detalhe.variavel[1] }}</td>
              <td class="align-middle"><code>{{ detalhe.variavel[2] }}</code></td>
              <td class="text-center align-middle">{{ detalhe.variavel[3] }}</td>
              <td class="text-center align-middle">{{ detalhe.variavel[4] }}</td>
              <td class="align-middle">
                {% if detalhe.alternativas %}
                  <ul class="list-unstyled ps-1 mb-0">
                    {% for alternativa in detalhe.alternativas %}
                      <li><code>{{ alternativa }}</code></li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted fst-italic">-</span>
                {% endif %}
              </td>
              <td class="align-middle">
                {% if detalhe.scripts %}
                  <ul class="list-unstyled ps-1 mb-0">
                    {% for script in detalhe.scripts %}
                      <li>{{ script[1] }}</li> {# Supondo que script[1] é o nome do script #}
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted fst-italic">-</span>
                {% endif %}
              </td>
              <td class="align-middle">
                {% if detalhe.anexos %}
                  <ul class="list-unstyled ps-1 mb-0 small">
                    {% for anexo in detalhe.anexos %}
                      <li>
                        <i class="bi bi-paperclip"></i> {{ anexo.descricao or anexo.tipo_anexo }}
                        {% if anexo.referencia %}
                          <span class="text-muted">(Ref: {{ anexo.referencia.autores|truncate(20, True) }} {{ anexo.referencia.ano }})</span>
                        {% endif %}
                        <a href="{% if anexo.tipo_anexo == 'URL' %}{{ anexo.caminho }}{% else %}{{ url_for('static', filename=anexo.caminho|replace('/static/', '')) }}{% endif %}" target="_blank" class="ms-1"><i class="bi bi-box-arrow-up-right"></i></a>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted fst-italic">-</span>
                {% endif %}
              </td>
              <td class="text-center align-middle">
                <div class="btn-group btn-group-sm" role="group" aria-label="Ações da Variável">
                  <a href="{{ url_for('variaveis.vincular_anexo', codvariavel=detalhe.variavel[0]) }}" class="btn btn-outline-dark" title="Vincular Anexo">
                    <i class="bi bi-paperclip"></i>
                  </a>
                  <a href="{{ url_for('variaveis.editar_variavel', codvariavel=detalhe.variavel[0]) }}" class="btn btn-outline-primary" title="Editar Variável">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <button type="button" class="btn btn-outline-info" 
                          data-bs-toggle="modal" 
                          data-bs-target="#detailsModal"
                          data-codvariavel="{{ detalhe.variavel[0] }}"
                          data-nome="{{ detalhe.variavel[1] }}"
                          data-variavel="{{ detalhe.variavel[2] }}"
                          title="Detalhes (Normalidade e Equações)">
                    <i class="bi bi-search-heart"></i>
                  </button>
                  {% if detalhe.formula %}
                    <button type="button" class="btn btn-outline-success" 
                            data-bs-toggle="modal" 
                            data-bs-target="#formulaModal"
                            data-codvariavel="{{ detalhe.variavel[0] }}"
                            data-variavel="{{ detalhe.variavel[2] }}"
                            data-formula="{{ detalhe.formula[0] }}"
                            data-casas="{{ detalhe.formula[1] }}"
                            title="Ver Fórmula">
                      <i class="bi bi-calculator"></i>
                    </button>
                  {% endif %}
                  <a href="{{ url_for('variaveis.consultar_estudos', codvariavel=detalhe.variavel[0]) }}" class="btn btn-outline-warning" title="Consultar Estudos">
                    <i class="bi bi-book"></i>
                  </a>
                   <button type="button" class="btn btn-outline-info ver-codigos-btn" 
                           data-codvariavel="{{ detalhe.variavel[0] }}" 
                           data-nome="{{ detalhe.variavel[1] }}" 
                           title="Ver códigos DICOM vinculados">
                     <i class="bi bi-qr-code-scan"></i>
                   </button>
                  <form action="{{ url_for('variaveis.excluir_variavel', codvariavel=detalhe.variavel[0]) }}" method="POST" class="d-inline excluir-variavel-form">
                    <button type="submit" class="btn btn-outline-danger" title="Excluir Variável">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if total_paginas > 0 %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-between">
        <li class="page-item align-self-center text-muted small">
          Página {{ pagina }} de {{ total_paginas }}
        </li>
        <li class="d-flex">
          {% if pagina > 1 %}
            <a class="page-link" href="{{ url_for('variaveis.visualizar_variaveis', page=pagina-1, variavel=request.args.get('variavel', '')) }}">
              <i class="bi bi-chevron-left"></i> Anterior
            </a>
          {% else %}
            <span class="page-link disabled" tabindex="-1" aria-disabled="true">
              <i class="bi bi-chevron-left"></i> Anterior
            </span>
          {% endif %}
          {% if pagina < total_paginas %}
            <a class="page-link" href="{{ url_for('variaveis.visualizar_variaveis', page=pagina+1, variavel=request.args.get('variavel', '')) }}">
              Próximo <i class="bi bi-chevron-right"></i>
            </a>
          {% else %}
            <span class="page-link disabled" tabindex="-1" aria-disabled="true">
              Próximo <i class="bi bi-chevron-right"></i>
            </span>
          {% endif %}
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Detalhes da Variável</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nome Clínico:</strong> <span id="detailsModalNomeClinico"></span></p>
        <p><strong>Variável:</strong> <code><span id="detailsModalVariavel"></span></code></p>
        <hr>
        <h6><i class="bi bi-rulers me-1"></i> Normalidade:</h6>
        <div id="detailsModalNormalidade">
          <p class="text-muted">Nenhuma informação de normalidade disponível.</p>
        </div>
        <hr>
        <h6><i class="bi bi-diagram-3 me-1"></i> Equações:</h6>
        <div id="detailsModalEquacoes">
          <p class="text-muted">Nenhuma equação associada.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="formulaModalLabel">Fórmula da Variável</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Variável:</strong> <code><span id="formulaModalVariavel"></span></code></p>
        <div class="mb-2">
          <strong>Fórmula:</strong>
          <pre class="bg-light p-2 rounded"><code><span id="formulaModalFormula"></span></code></pre>
        </div>
        <p><strong>Casas Decimais:</strong> <span id="formulaModalCasas"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // SweetAlert2 para confirmação de exclusão
  document.querySelectorAll('.excluir-variavel-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Confirmar Exclusão',
        text: 'Tem certeza que deseja excluir esta variável? Esta ação não pode ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-trash-fill me-1"></i> Sim, Excluir',
        cancelButtonText: '<i class="bi bi-x-circle me-1"></i> Cancelar',
        customClass: { popup: 'swal2-zindex-high' }
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });

  // Manipulação do Modal de Detalhes
  const detailsModalElement = document.getElementById('detailsModal');
  if (detailsModalElement) {
    detailsModalElement.addEventListener('show.bs.modal', async function (event) {
      const button = event.relatedTarget;
      const codVariavel = button.dataset.codvariavel;
      const nomeVariavel = button.dataset.nome;
      const varVariavel = button.dataset.variavel;

      const modalTitle = detailsModalElement.querySelector('.modal-title');
      const modalNomeClinico = detailsModalElement.querySelector('#detailsModalNomeClinico');
      const modalVariavel = detailsModalElement.querySelector('#detailsModalVariavel');
      const normalidadeDiv = detailsModalElement.querySelector('#detailsModalNormalidade');
      const equacoesDiv = detailsModalElement.querySelector('#detailsModalEquacoes');

      modalTitle.textContent = 'Detalhes da Variável: ' + nomeVariavel;
      modalNomeClinico.textContent = nomeVariavel;
      modalVariavel.textContent = varVariavel;
      
      normalidadeDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Carregando...</span></div> <span class="text-muted small">Carregando normalidade...</span></div>';
      equacoesDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Carregando...</span></div> <span class="text-muted small">Carregando equações...</span></div>';

      // TODO: Implementar fetch para buscar dados de normalidade e equações via AJAX.
      // Esta é uma simulação, substitua pelo seu fetch real.
      setTimeout(() => {
        normalidadeDiv.innerHTML = '<p class="text-muted fst-italic small"><i class="bi bi-info-circle me-1"></i>Dados de normalidade não disponíveis nesta visualização. Edite a variável para ver/modificar.</p>';
        equacoesDiv.innerHTML = '<p class="text-muted fst-italic small"><i class="bi bi-info-circle me-1"></i>Equações não disponíveis nesta visualização. Edite a variável para ver/modificar.</p>';
      }, 1000); // Simula um delay de rede
    });
  }

  // Manipulação do Modal de Fórmula
  const formulaModalElement = document.getElementById('formulaModal');
  if (formulaModalElement) {
    formulaModalElement.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const varVariavel = button.dataset.variavel;
      const formula = button.dataset.formula;
      const casas = button.dataset.casas;

      const modalTitle = formulaModalElement.querySelector('.modal-title');
      const modalVariavel = formulaModalElement.querySelector('#formulaModalVariavel');
      const modalFormula = formulaModalElement.querySelector('#formulaModalFormula');
      const modalCasas = formulaModalElement.querySelector('#formulaModalCasas');

      modalTitle.textContent = 'Fórmula da Variável: ' + varVariavel;
      modalVariavel.textContent = varVariavel;
      modalFormula.textContent = formula;
      modalCasas.textContent = casas;
    });
  }

  // Visualizar Códigos DICOM Vinculados (SweetAlert2)
  document.querySelectorAll('.ver-codigos-btn').forEach(button => {
    button.addEventListener('click', async function() {
      const codvariavel = this.dataset.codvariavel;
      const nomeVariavel = this.dataset.nome;

      Swal.fire({
        title: 'Códigos DICOM Vinculados',
        html: `
          <p class="text-start mb-1"><strong>Variável:</strong> ${nomeVariavel}</p>
          <div id="codigos-content" class="text-start mt-2">
            <h6 class="mb-1">Códigos Vinculados:</h6>
            <ul id="codigos-list" class="list-unstyled ps-3 small"><li><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Carregando...</span></div> Carregando...</li></ul>
          </div>`,
        showCloseButton: true,
        showConfirmButton: false, // Não precisa de botão de confirmar aqui
        customClass: { popup: 'swal2-zindex-high swal-wide' },
        didOpen: async () => {
          try {
            const response = await fetch(`/variaveis/get_codigos_vinculados/${codvariavel}`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const codigos = await response.json();
            
            const codigosList = Swal.getHtmlContainer().querySelector('#codigos-list');
            if (!codigosList) return;

            codigosList.innerHTML = ''; // Limpa o "Carregando..."
            if (codigos.error) {
              codigosList.innerHTML = `<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Erro: ${codigos.error}</li>`;
            } else if (codigos.length > 0) {
              codigos.forEach(codigo => {
                const li = document.createElement('li');
                li.innerHTML = `<code>${codigo.codigo}</code> - ${codigo.descricaoptbr || '<span class="text-muted fst-italic">Sem descrição em PT-BR</span>'}`;
                codigosList.appendChild(li);
              });
            } else {
              codigosList.innerHTML = '<li><i class="bi bi-info-circle me-1"></i>Nenhum código DICOM vinculado.</li>';
            }
          } catch (error) {
            console.error('Erro ao buscar códigos vinculados:', error);
            const codigosList = Swal.getHtmlContainer().querySelector('#codigos-list');
            if (codigosList) {
              codigosList.innerHTML = `<li class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Erro ao carregar os códigos.</li>`;
            }
          }
        }
      });
    });
  });
});

// Estilo para garantir que o modal do Swal fique na frente de modais Bootstrap
const styleSwalZIndex = document.createElement('style');
styleSwalZIndex.textContent = '.swal2-zindex-high { z-index: 1060 !important; } .swal-wide { width: 600px !important; }';
document.head.appendChild(styleSwalZIndex);
</script>
{% endset %}