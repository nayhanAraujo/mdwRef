{% extends 'layout.html' %}
{% block title %}Vincular Códigos DICOM a Variáveis{% endblock %}
{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-link-45deg me-2"></i> Vincular Códigos DICOM a Variáveis
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario']['nome'] }}</strong>
  </div>
</div>

<div class="container">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <!-- Mensagem de Erro/Sucesso -->
      {% if get_flashed_messages() %}
        <div class="alert alert-{{ 'danger' if get_flashed_messages(with_categories=true)[0][0] == 'error' else 'success' }} mb-3">
          {% for category, message in get_flashed_messages(with_categories=true) %}
            {{ message }}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Formulário de Vinculação -->
      <form method="POST" action="{{ url_for('variaveis.vincular_codigo_universal') }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Variável</label>
            <select name="codvariavel" class="form-select" required>
              <option value="">-- Selecione uma variável --</option>
              {% if variaveis %}
                {% for codvariavel, nome, sigla in variaveis %}
                  <option value="{{ codvariavel }}">{{ nome }} ({{ sigla }})</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>Nenhuma variável disponível</option>
              {% endif %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Códigos DICOM</label>
            <select name="dicom_codes[]" class="form-select select2-dicom" multiple required>
              <option value="">-- Digite para buscar --</option>
              {% if codigos_universais %}
                {% for cod_universal, codigo, descricaoptbr in codigos_universais %}
                  <option value="{{ cod_universal }}">{{ codigo }} - {{ descricaoptbr|default('Sem descrição em PT-BR') }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>Nenhum código DICOM disponível</option>
              {% endif %}
            </select>
            <small class="form-text text-muted">Digite para buscar ou selecione múltiplos códigos.</small>
          </div>
        </div>
        <div class="text-end mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Vincular
          </button>
          <a href="{{ url_for('variaveis.visualizar_variaveis') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Incluir jQuery (se não estiver no layout.html) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Incluir Select2 CSS e JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  console.log('Variáveis:', {{ variaveis | tojson }});
  console.log('Códigos DICOM:', {{ codigos_universais | tojson }});
  console.log('jQuery carregado:', typeof $ !== 'undefined' ? $.fn.jquery : 'Não carregado');
  console.log('Select2 carregado:', typeof $.fn.select2 !== 'undefined' ? 'Carregado' : 'Não carregado');

  // Inicializar Select2 no dropdown de códigos DICOM
  $(document).ready(function() {
    try {
      $('.select2-dicom').select2({
        placeholder: '-- Digite para buscar --',
        allowClear: true,
        width: '100%',
        minimumInputLength: 1,
        templateResult: function(data) {
          if (!data.id) {
            return data.text;
          }
          return $('<span>' + data.text + '</span>');
        }
      });
      console.log('Select2 inicializado com sucesso.');
    } catch (e) {
      console.error('Erro ao inicializar Select2:', e);
    }
  });

  document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    const variavel = document.querySelector('[name="codvariavel"]').value;
    const codigos = document.querySelector('[name="dicom_codes[]"]').selectedOptions.length;
    Swal.fire({
      title: 'Confirmar Vínculo',
      text: `Deseja vincular ${codigos} código(s) DICOM à variável selecionada?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Vincular',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        this.submit();
      }
    });
  });
</script>
{% endset %}