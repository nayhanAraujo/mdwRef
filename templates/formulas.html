{% extends 'layout.html' %}
{% block title %}Fórmulas Cadastradas{% endblock %}
{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-file-bar-graph-fill me-2"></i> Fórmulas Cadastradas
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario']['nome'] }}</strong>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <!-- Formulário de Filtros -->
    <form method="GET" action="{{ url_for('formulas.visualizar_formulas') }}" class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Variável (Sigla)</label>
          <input type="text" name="sigla" class="form-control" value="{{ filtro_sigla }}" placeholder="Ex.: VR_AO1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Nome</label>
          <input type="text" name="nome" class="form-control" value="{{ filtro_nome }}" placeholder="Ex.: Fórmula para VR_AO1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fórmula</label>
          <input type="text" name="formula" class="form-control" value="{{ filtro_formula }}" placeholder="Ex.: VR_AO1 * 2">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Filtrar
          </button>
        </div>
      </div>
    </form>

    <!-- Mensagem de Erro -->
    {% if get_flashed_messages() %}
      <div class="alert alert-danger mb-3">
        {% for category, message in get_flashed_messages(with_categories=true) %}
          {{ message }}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Tabela de Fórmulas -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th>Variável</th>
            <th>Nome</th>
            <th>Fórmula</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% if formulas %}
            {% for cod, nome, formula, sigla in formulas %}
              <tr>
                <td class="text-center">{{ sigla }}</td>
                <td>{{ nome }}</td>
                <td>{{ formula }}</td>
                <td class="text-center">
                  <a href="{{ url_for('formulas.editar_formula', codformula=cod) }}" class="btn btn-sm btn-outline-warning">
                    <i class="bi bi-pencil-square"></i> Editar
                  </a>
                  <form action="{{ url_for('formulas.excluir_formula', codformula=cod) }}" method="POST" class="d-inline excluir-formula-form">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i> Excluir
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center">Nenhuma fórmula encontrada.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    {% if total_paginas > 1 %}
      <nav aria-label="Paginação">
        <ul class="pagination justify-content-center">
          {% if pagina > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('formulas.visualizar_formulas', page=pagina-1, sigla=filtro_sigla, nome=filtro_nome, formula=filtro_formula) }}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Anterior</span>
            </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Página {{ pagina }} de {{ total_paginas }}</span>
          </li>
          {% if pagina < total_paginas %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('formulas.visualizar_formulas', page=pagina+1, sigla=filtro_sigla, nome=filtro_nome, formula=filtro_formula) }}">Próxima</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Próxima</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

    <!-- Botões de Ação -->
    <div class="d-flex justify-content-between">
      <a href="{{ url_for('formulas.nova_formula') }}" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Nova Fórmula
      </a>
      <a href="{{ url_for('variaveis.home') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.excluir-formula-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Confirmar Exclusão',
        text: 'Deseja realmente excluir esta fórmula?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Excluir',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });
</script>
{% endset %}