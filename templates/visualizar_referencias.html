{% extends 'layout.html' %}

{% set content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary mb-0">
    <i class="bi bi-list-ul me-2"></i> Referências Cadastradas
  </h3>
  <div class="text-muted small">
    Usuário logado: <strong>{{ session['usuario']['nome'] }}</strong>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <!-- Formulário de Filtros -->
    <form method="GET" action="{{ url_for('referencias.visualizar_referencias') }}" class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Título</label>
          <input type="text" name="titulo" class="form-control" value="{{ filtro_titulo }}" placeholder="Ex.: Estudo sobre Fração">
        </div>
        <div class="col-md-2">
          <label class="form-label">Ano</label>
          <input type="number" name="ano" class="form-control" value="{{ filtro_ano }}" placeholder="Ex.: 2020">
        </div>
        <div class="col-md-3">
          <label class="form-label">Autor/Organização</label>
          <input type="text" name="autor" class="form-control" value="{{ filtro_autor }}" placeholder="Ex.: Simpson">
        </div>
        <div class="col-md-2">
          <label class="form-label">Abreviação</label>
          <input type="text" name="abreviacao" class="form-control" value="{{ filtro_abreviacao }}" placeholder="Ex.: SIMP">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Filtrar
          </button>
        </div>
      </div>
    </form>

    <!-- Mensagem de Erro -->
    {% if get_flashed_messages() %}
      <div class="alert alert-danger mb-3">
        {% for message in get_flashed_messages() %}
          {{ message }}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Tabela de Referências -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Autores (Abreviação)</th>
            <th>Ano</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% if referencias %}
            {% for cod, titulo, ano, autores, descricao, especialidade in referencias %}
              <tr>
                <td class="text-center">{{ cod }}</td>
                <td>{{ titulo }}</td>
                <td>{{ autores or 'Nenhum autor' }}</td>
                <td class="text-center">{{ ano or '-' }}</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-success preview-btn" 
                          data-bs-toggle="modal" 
                          data-bs-target="#referenciaModal"
                          data-codreferencia="{{ cod }}"
                          data-titulo="{{ titulo }}"
                          data-ano="{{ ano }}"
                          data-autores="{{ autores or 'Nenhum autor' }}"
                          data-descricao="{{ descricao or '-' }}"
                          data-especialidade="{{ especialidade or '-' }}">
                    <i class="bi bi-eye"></i> Visualizar
                  </button>
                  <a href="{{ url_for('referencias.editar_referencia', codreferencia=cod) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil-square"></i> Editar
                  </a>
                  <a href="{{ url_for('referencias.visualizar_anexos', codreferencia=cod) }}" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-paperclip"></i> Anexos
                  </a>
                  <form action="{{ url_for('referencias.excluir_referencia', codreferencia=cod) }}" method="post" class="d-inline excluir-referencia-form">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i> Excluir
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="text-center">Nenhuma referência encontrada.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    {% if total_paginas > 1 %}
      <nav aria-label="Paginação">
        <ul class="pagination justify-content-center">
          {% if pagina > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('referencias.visualizar_referencias', page=pagina-1, titulo=filtro_titulo, ano=filtro_ano, autor=filtro_autor, abreviacao=filtro_abreviacao) }}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Anterior</span>
            </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Página {{ pagina }} de {{ total_paginas }}</span>
          </li>
          {% if pagina < total_paginas %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('referencias.visualizar_referencias', page=pagina+1, titulo=filtro_titulo, ano=filtro_ano, autor=filtro_autor, abreviacao=filtro_abreviacao) }}">Próxima</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Próxima</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

    <!-- Botão Voltar -->
    <div class="text-end">
      <a href="{{ url_for('bibliotecas.biblioteca') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar para Biblioteca
      </a>
    </div>
  </div>
</div>

<!-- Modal de Pré-visualização -->
<div class="modal fade" id="referenciaModal" tabindex="-1" aria-labelledby="referenciaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="referenciaModalLabel">Detalhes da Referência</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Título:</strong> <span id="modal-titulo"></span></p>
        <p><strong>Ano:</strong> <span id="modal-ano"></span></p>
        <p><strong>Autores:</strong> <span id="modal-autores"></span></p>
        <p><strong>Descrição:</strong> <span id="modal-descricao"></span></p>
        <p><strong>Especialidade:</strong> <span id="modal-especialidade"></span></p>
        <div id="modal-anexos">
          <strong>Anexos:</strong>
          <ul id="modal-anexos-list"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.preview-btn').forEach(button => {
    button.addEventListener('click', async function() {
      // Preencher dados do modal
      document.getElementById('modal-titulo').textContent = this.dataset.titulo;
      document.getElementById('modal-ano').textContent = this.dataset.ano;
      document.getElementById('modal-autores').textContent = this.dataset.autores;
      document.getElementById('modal-descricao').textContent = this.dataset.descricao;
      document.getElementById('modal-especialidade').textContent = this.dataset.especialidade;

      // Buscar anexos via AJAX
      const anexosList = document.getElementById('modal-anexos-list');
      anexosList.innerHTML = '<li>Carregando...</li>';
      try {
        const response = await fetch(`/referencias/get_anexos/${this.dataset.codreferencia}`);
        const data = await response.json();
        anexosList.innerHTML = '';
        if (data.error) {
          anexosList.innerHTML = '<li>Erro ao carregar anexos: ' + data.error + '</li>';
        } else if (data.length > 0) {
          data.forEach(anexo => {
            console.log('Anexo:', anexo); // Depuração
            const li = document.createElement('li');
            if (anexo.caminho && anexo.caminho.startsWith('/static/uploads/')) {
              li.innerHTML = `${anexo.descricao} (${anexo.tipo}) - <a href="${anexo.caminho}" target="_blank" class="anexo-link">Visualizar</a>`;
            } else {
              li.innerHTML = `${anexo.descricao} (${anexo.tipo}) - <span class="text-muted">Link inválido</span>`;
            }
            anexosList.appendChild(li);
          });
        } else {
          anexosList.innerHTML = '<li>Nenhum anexo disponível.</li>';
        }
      } catch (error) {
        anexosList.innerHTML = '<li>Erro ao carregar anexos.</li>';
        console.error('Erro ao buscar anexos:', error);
      }
    });
  });

  // Depuração para cliques nos links
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('anexo-link')) {
      console.log('Link clicado:', e.target.href);
    }
  });

  document.querySelectorAll('.excluir-referencia-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Confirmar Exclusão',
        text: 'Deseja excluir esta referência? Isso pode afetar registros vinculados.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Excluir',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit();
        }
      });
    });
  });
</script>
{% endset %}